<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±å­¸å®¶æ•™æ’ç¨‹ç³»çµ± | Tutor Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* Stone 100 */
        }

        /* Chart Container Styling per requirements */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        /* Custom Scrollbar for list areas */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #e7e5e4;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #a8a29e;
            border-radius: 3px;
        }

        /* Tab transition */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calendar-day {
            min-height: 100px;
        }
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 80px;
            }
        }
    </style>
    <!-- Chosen Palette: Warm Neutrals (Stone, Warm Gray, Muted Orange, Sage Green) -->
    <!-- Application Structure Plan: 
         1. Dashboard/Calendar (Public View): The central hub showing approved classes and school events.
         2. Tutor Portal (Input): A dedicated section for teachers to submit "Pending" requests.
         3. Admin Portal (Control): The verification layer where the user approves/rejects requests.
         4. Analytics: A simple visual breakdown of class types.
         Rationale: This structure separates concerns (Input vs. View vs. Control) while keeping everything on one accessible page.
    -->
    <!-- Visualization & Content Choices:
         1. Calendar Grid (HTML/JS): Main visualization of time.
         2. Doughnut Chart (Chart.js): Shows the ratio of Art/Drums/English classes (Goal: Inform/Compare).
         3. Status lists (HTML/JS): Color-coded lists for pending vs. approved items.
         4. Unicode Icons: Used instead of SVG for lightweight visual cues.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="text-stone-800">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">ğŸ“…</span>
                    <h1 class="font-bold text-xl tracking-tight text-stone-700">å…±å­¸æ’ç¨‹ç³»çµ± <span class="text-sm font-normal text-stone-500">| æ•´åˆå—ç§‘å¯¦å°è¡Œäº‹æ›†</span></h1>
                </div>
                <div class="hidden md:flex space-x-4">
                    <button onclick="switchTab('view-calendar')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-stone-900 bg-stone-100 hover:bg-stone-200 transition">è¡Œäº‹æ›†ç¸½è¦½</button>
                    <button onclick="switchTab('view-tutor')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:bg-stone-100 transition">è€å¸«å¡«å¯«å€</button>
                    <button onclick="switchTab('view-admin')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:bg-stone-100 transition">ç®¡ç†å“¡å¯©æ ¸</button>
                </div>
                <!-- Mobile Menu Button (Simplified for prototype) -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-stone-600 focus:outline-none">â˜°</button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-b border-stone-200">
            <button onclick="switchTab('view-calendar')" class="block w-full text-left px-4 py-2 text-stone-700 hover:bg-stone-100">è¡Œäº‹æ›†ç¸½è¦½</button>
            <button onclick="switchTab('view-tutor')" class="block w-full text-left px-4 py-2 text-stone-700 hover:bg-stone-100">è€å¸«å¡«å¯«å€</button>
            <button onclick="switchTab('view-admin')" class="block w-full text-left px-4 py-2 text-stone-700 hover:bg-stone-100">ç®¡ç†å“¡å¯©æ ¸</button>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main class="max-w-6xl mx-auto px-4 py-8">

        <!-- VIEW 1: CALENDAR & DASHBOARD -->
        <div id="view-calendar" class="tab-content active">
            
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-stone-800 mb-2">æœ¬æœˆèª²ç¨‹èˆ‡å­¸æ ¡è¡Œç¨‹</h2>
                <p class="text-stone-600 leading-relaxed">
                    é€™æ˜¯æ‰€æœ‰å·²ç¢ºèªèª²ç¨‹çš„å…¬é–‹é é¢ã€‚åŒ…å«è‹±æ–‡ã€çˆµå£«é¼“èˆ‡ç¾è¡“èª²ï¼Œä¸¦æ•´åˆäº†å—ç§‘å¯¦å°çš„é‡å¤§æ´»å‹•ä»¥é¿å…è¡çªã€‚<br>
                    <span class="inline-block mt-2 text-sm bg-orange-100 text-orange-800 px-2 py-1 rounded">ğŸ« å­¸æ ¡æ´»å‹•</span>
                    <span class="inline-block mt-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">ğŸ‡ºğŸ‡¸ è‹±æ–‡</span>
                    <span class="inline-block mt-2 text-sm bg-purple-100 text-purple-800 px-2 py-1 rounded">ğŸ¥ çˆµå£«é¼“</span>
                    <span class="inline-block mt-2 text-sm bg-emerald-100 text-emerald-800 px-2 py-1 rounded">ğŸ¨ ç¾è¡“</span>
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Calendar Section -->
                <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                    <div class="flex justify-between items-center p-4 bg-stone-50 border-b border-stone-200">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-stone-200 rounded-full transition">â¬…ï¸</button>
                        <h3 id="calendar-title" class="text-lg font-bold text-stone-700">2026å¹´ 1æœˆ</h3>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-stone-200 rounded-full transition">â¡ï¸</button>
                    </div>
                    
                    <!-- Weekday Headers -->
                    <div class="grid grid-cols-7 border-b border-stone-200 bg-stone-50">
                        <div class="py-2 text-center text-xs font-bold text-stone-500">æ—¥</div>
                        <div class="py-2 text-center text-xs font-bold text-stone-500">ä¸€</div>
                        <div class="py-2 text-center text-xs font-bold text-stone-500">äºŒ</div>
                        <div class="py-2 text-center text-xs font-bold text-stone-500">ä¸‰</div>
                        <div class="py-2 text-center text-xs font-bold text-stone-500">å››</div>
                        <div class="py-2 text-center text-xs font-bold text-stone-500">äº”</div>
                        <div class="py-2 text-center text-xs font-bold text-stone-500">å…­</div>
                    </div>

                    <!-- Calendar Grid -->
                    <div id="calendar-grid" class="grid grid-cols-7 bg-white">
                        <!-- JS generates days here -->
                    </div>
                </div>

                <!-- Info/Stats Section -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Analytics Chart -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-200">
                        <h3 class="text-sm font-bold text-stone-500 uppercase mb-4 tracking-wider">èª²ç¨‹åˆ†ä½ˆæ¦‚æ³</h3>
                        <div class="chart-container">
                            <canvas id="classTypeChart"></canvas>
                        </div>
                        <p class="text-xs text-stone-400 mt-2 text-center">çµ±è¨ˆæœ¬æœˆå·²ç¢ºèªä¹‹èª²ç¨‹æ¯”ä¾‹</p>
                    </div>

                    <!-- Upcoming List -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-200">
                        <h3 class="text-sm font-bold text-stone-500 uppercase mb-4 tracking-wider">å³å°‡åˆ°ä¾†çš„èª²ç¨‹</h3>
                        <div id="upcoming-list" class="space-y-3 max-h-64 overflow-y-auto custom-scroll">
                            <!-- JS populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: TUTOR PORTAL -->
        <div id="view-tutor" class="tab-content">
            <div class="max-w-2xl mx-auto">
                <div class="mb-8 text-center">
                    <h2 class="text-3xl font-bold text-stone-800 mb-3">è€å¸«èª²ç¨‹ç™»è¨˜</h2>
                    <p class="text-stone-600">
                        è«‹å¡«å¯«ä¸‹æ–¹è¡¨å–®ä»¥æ–°å¢èª²ç¨‹ã€‚æ³¨æ„ï¼šæ‚¨çš„èª²ç¨‹åœ¨é€å‡ºå¾Œæœƒé€²å…¥<span class="font-bold text-orange-600">ã€Œå¾…å¯©æ ¸ã€</span>ç‹€æ…‹ï¼Œéœ€ç­‰å¾…ç®¡ç†å“¡ç¢ºèªå¾Œæ‰æœƒé¡¯ç¤ºæ–¼è¡Œäº‹æ›†ä¸Šã€‚
                    </p>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-stone-200 p-6 md:p-8">
                    <form id="class-form" onsubmit="handleTutorSubmit(event)">
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-stone-700 mb-2">æˆ‘æ˜¯...</label>
                            <div class="grid grid-cols-3 gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="teacherType" value="English" class="peer sr-only" checked>
                                    <div class="text-center p-3 border border-stone-200 rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition hover:bg-stone-50">
                                        <div class="text-xl mb-1">ğŸ‡ºğŸ‡¸</div>
                                        <div class="text-sm font-bold">è‹±æ–‡è€å¸«</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="teacherType" value="Drums" class="peer sr-only">
                                    <div class="text-center p-3 border border-stone-200 rounded-lg peer-checked:bg-purple-50 peer-checked:border-purple-500 peer-checked:text-purple-700 transition hover:bg-stone-50">
                                        <div class="text-xl mb-1">ğŸ¥</div>
                                        <div class="text-sm font-bold">çˆµå£«é¼“è€å¸«</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="teacherType" value="Art" class="peer sr-only">
                                    <div class="text-center p-3 border border-stone-200 rounded-lg peer-checked:bg-emerald-50 peer-checked:border-emerald-500 peer-checked:text-emerald-700 transition hover:bg-stone-50">
                                        <div class="text-xl mb-1">ğŸ¨</div>
                                        <div class="text-sm font-bold">ç¾è¡“è€å¸«</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="classDate" class="block text-sm font-medium text-stone-700 mb-2">ä¸Šèª²æ—¥æœŸ</label>
                                <input type="date" id="classDate" required class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-stone-400 focus:border-stone-400 outline-none transition">
                            </div>
                            <div>
                                <label for="classTime" class="block text-sm font-medium text-stone-700 mb-2">é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="classTime" required class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-stone-400 focus:border-stone-400 outline-none transition">
                            </div>
                        </div>

                        <div class="mb-8">
                            <label for="classSubject" class="block text-sm font-medium text-stone-700 mb-2">èª²ç¨‹ä¸»æ—¨ / å…§å®¹æ‘˜è¦</label>
                            <input type="text" id="classSubject" placeholder="ä¾‹å¦‚ï¼šUnit 5 è¤‡ç¿’ã€æ°´å½©åŸºç¤æŠ€æ³•..." required class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-stone-400 focus:border-stone-400 outline-none transition">
                            <p class="text-xs text-stone-500 mt-2">è«‹ç°¡çŸ­èªªæ˜æœ¬æ¬¡ä¸Šèª²é‡é»ã€‚</p>
                        </div>

                        <button type="submit" class="w-full bg-stone-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-stone-700 transform active:scale-95 transition shadow-lg">
                            é€å‡ºèª²ç¨‹ç”³è«‹
                        </button>
                    </form>
                </div>
                
                <!-- Conflict Alert Area -->
                <div id="conflict-alert" class="hidden mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg flex items-start space-x-3">
                    <span class="text-orange-600 text-xl">âš ï¸</span>
                    <div>
                        <h4 class="font-bold text-orange-800">æ³¨æ„ï¼šæ—¥æœŸè¡çªæç¤º</h4>
                        <p class="text-sm text-orange-700 mt-1">æ‚¨é¸æ“‡çš„æ—¥æœŸç•¶å¤©å­¸æ ¡æœ‰æ´»å‹•ï¼š<span id="conflict-event-name" class="font-bold"></span>ã€‚è«‹ç¢ºèªæ™‚é–“æ˜¯å¦å…è¨±ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: ADMIN PORTAL -->
        <div id="view-admin" class="tab-content">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-stone-800">ç®¡ç†å“¡å¯©æ ¸å°</h2>
                    <p class="text-stone-600">æ­¤è™•åˆ—å‡ºè€å¸«æäº¤çš„æ‰€æœ‰è«‹æ±‚ã€‚æ‚¨ç¢ºèªå¾Œï¼Œèª²ç¨‹æ‰æœƒæ­£å¼æ’å…¥è¡Œäº‹æ›†ã€‚</p>
                </div>
                <div class="bg-stone-100 px-4 py-2 rounded-lg text-sm font-medium text-stone-600">
                    å¾…å¯©æ ¸é …ç›®: <span id="pending-count" class="text-orange-600 font-bold text-lg">0</span>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <!-- Pending List -->
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                    <div class="bg-orange-50 px-6 py-4 border-b border-orange-100">
                        <h3 class="font-bold text-orange-800 flex items-center">
                            <span class="mr-2">â³</span> å¾…å¯©æ ¸èª²ç¨‹
                        </h3>
                    </div>
                    <div id="admin-pending-list" class="divide-y divide-stone-100">
                        <!-- Populated by JS -->
                        <div class="p-8 text-center text-stone-400 italic" id="empty-pending-msg">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„èª²ç¨‹</div>
                    </div>
                </div>

                <!-- Approved List (History) -->
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden opacity-80">
                    <div class="bg-stone-50 px-6 py-4 border-b border-stone-200">
                        <h3 class="font-bold text-stone-600 flex items-center">
                            <span class="mr-2">âœ…</span> æœ€è¿‘å·²ç¢ºèªèª²ç¨‹
                        </h3>
                    </div>
                    <div id="admin-approved-list" class="divide-y divide-stone-100 max-h-60 overflow-y-auto custom-scroll">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA STATE MANAGEMENT ---
        
        // Mocking Nanke Experimental Elementary School Data (2026 Sample)
        const schoolEvents = [
            { id: 's1', date: '2026-01-20', title: 'çµæ¥­å¼', type: 'school' },
            { id: 's2', date: '2026-01-21', title: 'å¯’å‡é–‹å§‹', type: 'school' },
            { id: 's3', date: '2026-02-11', title: 'é–‹å­¸æ—¥', type: 'school' },
            { id: 's4', date: '2026-02-28', title: 'å’Œå¹³ç´€å¿µæ—¥', type: 'school' },
            { id: 's5', date: '2026-04-03', title: 'å…’ç«¥ç¯€æ´»å‹•', type: 'school' },
            { id: 's6', date: '2026-01-14', title: 'æœŸæœ«è€ƒ(1)', type: 'school' },
            { id: 's7', date: '2026-01-15', title: 'æœŸæœ«è€ƒ(2)', type: 'school' },
        ];

        // Core Data: Classes
        let classes = [
            { id: 1, type: 'English', teacher: 'Teacher Alex', date: '2026-01-12', time: '18:00', subject: 'Unit 4 Vocabulary', status: 'approved' },
            { id: 2, type: 'Drums', teacher: 'Drummer Mike', date: '2026-01-14', time: '19:30', subject: 'Basic Rhythm L2', status: 'approved' },
            { id: 3, type: 'Art', teacher: 'Ms. Lin', date: '2026-01-18', time: '14:00', subject: 'Sketching Basics', status: 'pending' },
            { id: 4, type: 'English', teacher: 'Teacher Alex', date: '2026-01-22', time: '18:00', subject: 'Reading Comprehension', status: 'approved' },
        ];

        // State for Calendar View
        let currentDate = new Date(2026, 0, 1); // Start at Jan 2026
        
        // --- DOM ELEMENTS ---
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarTitle = document.getElementById('calendar-title');
        const upcomingList = document.getElementById('upcoming-list');
        const pendingListEl = document.getElementById('admin-pending-list');
        const approvedListEl = document.getElementById('admin-approved-list');
        const pendingCountEl = document.getElementById('pending-count');
        const conflictAlert = document.getElementById('conflict-alert');
        const conflictName = document.getElementById('conflict-event-name');

        // --- CHART CONFIGURATION ---
        let chartInstance = null;

        function initChart() {
            const ctx = document.getElementById('classTypeChart').getContext('2d');
            
            // Calculate data
            const approved = classes.filter(c => c.status === 'approved');
            const engCount = approved.filter(c => c.type === 'English').length;
            const drumCount = approved.filter(c => c.type === 'Drums').length;
            const artCount = approved.filter(c => c.type === 'Art').length;

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['è‹±æ–‡', 'çˆµå£«é¼“', 'ç¾è¡“'],
                    datasets: [{
                        data: [engCount, drumCount, artCount],
                        backgroundColor: [
                            '#bfdbfe', // Blue 200
                            '#e9d5ff', // Purple 200
                            '#a7f3d0'  // Emerald 200
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: { family: "'Noto Sans TC', sans-serif" }
                            }
                        }
                    }
                }
            });
        }

        // --- CORE FUNCTIONS ---

        // 1. Navigation Logic
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Show selected
            document.getElementById(tabId).classList.add('active');
            
            // Re-render specific components if needed
            if(tabId === 'view-calendar') {
                renderCalendar();
                initChart();
            } else if (tabId === 'view-admin') {
                renderAdminPanel();
            }

            // Mobile menu close logic
            document.getElementById('mobile-menu').classList.add('hidden');
        }

        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }

        // 2. Calendar Logic
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            calendarTitle.innerText = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Empty slots for days before start of month
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'border-b border-r border-stone-100 bg-stone-50/30 min-h-[100px]';
                calendarGrid.appendChild(emptyCell);
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day border-b border-r border-stone-100 p-2 relative hover:bg-stone-50 transition bg-white';
                
                // Date Number
                const dateNum = document.createElement('div');
                dateNum.className = 'text-sm font-semibold text-stone-400 mb-1';
                dateNum.innerText = day;
                cell.appendChild(dateNum);

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // A. Check for School Events
                const sEvent = schoolEvents.find(e => e.date === dateStr);
                if (sEvent) {
                    const el = document.createElement('div');
                    el.className = 'text-xs bg-orange-100 text-orange-800 rounded px-1 py-0.5 mb-1 truncate font-medium';
                    el.title = sEvent.title;
                    el.innerText = `ğŸ« ${sEvent.title}`;
                    cell.appendChild(el);
                    cell.classList.add('bg-orange-50/30'); // Highlight school event days slightly
                }

                // B. Check for Approved Classes
                const dayClasses = classes.filter(c => c.date === dateStr && c.status === 'approved');
                dayClasses.forEach(c => {
                    const el = document.createElement('div');
                    let colorClass = '';
                    let icon = '';
                    
                    if (c.type === 'English') { colorClass = 'bg-blue-100 text-blue-800'; icon='ğŸ‡ºğŸ‡¸'; }
                    else if (c.type === 'Drums') { colorClass = 'bg-purple-100 text-purple-800'; icon='ğŸ¥'; }
                    else if (c.type === 'Art') { colorClass = 'bg-emerald-100 text-emerald-800'; icon='ğŸ¨'; }

                    el.className = `text-xs ${colorClass} rounded px-1 py-0.5 mb-1 cursor-pointer hover:opacity-80 transition`;
                    el.title = `${c.time} - ${c.subject}`;
                    el.innerHTML = `<div class="font-bold">${c.time}</div><div class="truncate">${icon} ${c.subject}</div>`;
                    
                    // Simple interaction: Alert details
                    el.onclick = () => alert(`èª²ç¨‹è©³æƒ…:\n\næ™‚é–“: ${c.time}\nè€å¸«: ${c.teacher}\nä¸»æ—¨: ${c.subject}\nç‹€æ…‹: å·²ç¢ºèª`);
                    
                    cell.appendChild(el);
                });

                calendarGrid.appendChild(cell);
            }

            renderUpcoming();
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }

        // 3. Upcoming List Logic
        function renderUpcoming() {
            upcomingList.innerHTML = '';
            // Filter future approved classes, sort by date
            const todayStr = new Date().toISOString().split('T')[0];
            const upcoming = classes
                .filter(c => c.status === 'approved' && c.date >= todayStr)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 5); // Take top 5

            if (upcoming.length === 0) {
                upcomingList.innerHTML = '<div class="text-stone-400 text-xs text-center py-4">è¿‘æœŸç„¡èª²ç¨‹</div>';
                return;
            }

            upcoming.forEach(c => {
                let badgeColor = c.type === 'English' ? 'bg-blue-100 text-blue-800' : (c.type === 'Drums' ? 'bg-purple-100 text-purple-800' : 'bg-emerald-100 text-emerald-800');
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-3 text-sm p-2 hover:bg-stone-50 rounded transition';
                item.innerHTML = `
                    <div class="flex-shrink-0 w-12 text-center bg-stone-100 rounded p-1">
                        <div class="font-bold text-stone-600">${c.date.split('-')[1]}/${c.date.split('-')[2]}</div>
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="font-medium text-stone-800 truncate">${c.subject}</div>
                        <div class="text-xs text-stone-500">${c.time} | ${c.teacher}</div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded ${badgeColor} font-bold">${c.type}</span>
                `;
                upcomingList.appendChild(item);
            });
        }

        // 4. Tutor Form Logic
        document.getElementById('classDate').addEventListener('change', function(e) {
            const date = e.target.value;
            const conflict = schoolEvents.find(ev => ev.date === date);
            if (conflict) {
                conflictAlert.classList.remove('hidden');
                conflictName.innerText = conflict.title;
            } else {
                conflictAlert.classList.add('hidden');
            }
        });

        function handleTutorSubmit(e) {
            e.preventDefault();
            const type = document.querySelector('input[name="teacherType"]:checked').value;
            const date = document.getElementById('classDate').value;
            const time = document.getElementById('classTime').value;
            const subject = document.getElementById('classSubject').value;

            // Generate Teacher Name based on type (Mocking login)
            let teacherName = 'Teacher';
            if (type === 'English') teacherName = 'Teacher Alex';
            else if (type === 'Drums') teacherName = 'Drummer Mike';
            else teacherName = 'Ms. Lin';

            const newClass = {
                id: Date.now(),
                type,
                teacher: teacherName,
                date,
                time,
                subject,
                status: 'pending'
            };

            classes.push(newClass);
            
            // Reset form and Feedback
            e.target.reset();
            conflictAlert.classList.add('hidden');
            alert('âœ… ç”³è«‹å·²é€å‡ºï¼\n\næ‚¨çš„èª²ç¨‹å·²é€²å…¥ã€Œå¾…å¯©æ ¸ã€åˆ—è¡¨ã€‚è«‹ç­‰å¾…ç®¡ç†å“¡ç¢ºèªå¾Œï¼Œè©²èª²ç¨‹æ‰æœƒé¡¯ç¤ºåœ¨è¡Œäº‹æ›†ä¸Šã€‚');
            
            // Update counts immediately
            renderAdminPanel();
            switchTab('view-calendar'); // Auto switch back to calendar (optional UX choice)
        }

        // 5. Admin Panel Logic
        function renderAdminPanel() {
            pendingListEl.innerHTML = '';
            approvedListEl.innerHTML = '';
            
            const pending = classes.filter(c => c.status === 'pending');
            const approved = classes.filter(c => c.status === 'approved').sort((a,b) => new Date(b.date) - new Date(a.date));

            pendingCountEl.innerText = pending.length;
            document.getElementById('empty-pending-msg').style.display = pending.length === 0 ? 'block' : 'none';

            // Render Pending
            pending.forEach(c => {
                const div = document.createElement('div');
                div.className = 'p-4 md:p-6 flex flex-col md:flex-row justify-between items-start md:items-center hover:bg-stone-50 transition';
                div.innerHTML = `
                    <div class="mb-3 md:mb-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-lg text-stone-800">${c.date}</span>
                            <span class="text-stone-500 font-medium">@ ${c.time}</span>
                            <span class="px-2 py-0.5 rounded text-xs font-bold ${c.type === 'English' ? 'bg-blue-100 text-blue-800' : (c.type === 'Drums' ? 'bg-purple-100 text-purple-800' : 'bg-emerald-100 text-emerald-800')}">${c.type}</span>
                        </div>
                        <div class="text-stone-700 font-medium">ä¸»æ—¨ï¼š${c.subject}</div>
                        <div class="text-sm text-stone-500">è€å¸«ï¼š${c.teacher}</div>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="updateStatus(${c.id}, 'approved')" class="flex-1 md:flex-none bg-stone-800 text-white px-4 py-2 rounded hover:bg-stone-700 transition shadow-sm font-medium">âœ… ç¢ºèªæ’èª²</button>
                        <button onclick="deleteClass(${c.id})" class="flex-1 md:flex-none bg-white border border-stone-300 text-stone-600 px-4 py-2 rounded hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition">åˆªé™¤</button>
                    </div>
                `;
                pendingListEl.appendChild(div);
            });

            // Render Approved (History)
            approved.slice(0, 10).forEach(c => {
                const div = document.createElement('div');
                div.className = 'p-4 flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <span class="text-sm font-bold text-stone-700 mr-2">${c.date}</span>
                        <span class="text-sm text-stone-600">${c.subject}</span>
                    </div>
                    <span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded">å·²ç¢ºèª</span>
                `;
                approvedListEl.appendChild(div);
            });
        }

        function updateStatus(id, newStatus) {
            const idx = classes.findIndex(c => c.id === id);
            if (idx !== -1) {
                classes[idx].status = newStatus;
                renderAdminPanel();
                initChart(); // Update stats
                alert(`èª²ç¨‹å·²ç¢ºèªï¼\nå·²åŠ å…¥è¡Œäº‹æ›†ã€‚`);
            }
        }

        function deleteClass(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç”³è«‹å—ï¼Ÿ')) {
                classes = classes.filter(c => c.id !== id);
                renderAdminPanel();
            }
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            renderCalendar();
            initChart();
            renderUpcoming();
            renderAdminPanel();
        };

    </script>
</body>
</html>